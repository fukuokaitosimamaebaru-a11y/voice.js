<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã¡ã‹ã¾ã‚‹ã‚¢ãƒŠã‚¦ãƒ³ã‚¹</title>
<style>
body {
  margin:0;
  background:#0b1c2d;
  color:#fff;
  font-family: system-ui, sans-serif;
}
#app {
  text-align:center;
  padding:20px;
}
button {
  font-size:16px;
  padding:10px 16px;
  margin:6px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.start { background:#2ecc71; }
.stop  { background:#e74c3c; }
.effect { background:#3498db; }
</style>
</head>
<body>

<div id="app">
  <h1>ğŸš‡ ã¡ã‹ã¾ã‚‹ã‚¢ãƒŠã‚¦ãƒ³ã‚¹</h1>
  <button class="start">â–¶ é–‹å§‹</button>
  <button class="stop">â¹ åœæ­¢</button><br>
  <button class="effect">ã¡ã‹ã¾ã‚‹æœ€çµ‚</button>
</div>

<script>
/* ===== AudioWorkletï¼ˆéŸ³ç¨‹è£œæ­£ï¼‰ ===== */
const workletCode = `
class PitchProcessor extends AudioWorkletProcessor {
  static get parameterDescriptors() {
    return [{
      name: "pitch",
      defaultValue: 1.12,
      minValue: 0.8,
      maxValue: 1.5
    }];
  }
  process(inputs, outputs, params) {
    const input = inputs[0];
    const output = outputs[0];
    if (!input[0]) return true;
    const p = params.pitch[0];
    for (let ch = 0; ch < input.length; ch++) {
      for (let i = 0; i < input[ch].length; i++) {
        const idx = Math.floor(i * p) % input[ch].length;
        output[ch][i] = input[ch][idx];
      }
    }
    return true;
  }
}
registerProcessor("pitch-processor", PitchProcessor);
`;

let audioCtx, stream, source, pitchNode;

/* ===== ãƒã‚¤ã‚¯é–‹å§‹ ===== */
async function startMic() {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioCtx = new AudioContext();

  const blob = new Blob([workletCode], { type: "application/javascript" });
  const url = URL.createObjectURL(blob);
  await audioCtx.audioWorklet.addModule(url);

  source = audioCtx.createMediaStreamSource(stream);
  pitchNode = new AudioWorkletNode(audioCtx, "pitch-processor");
  pitchNode.parameters.get("pitch").value = 1.12;

  alert("ãƒã‚¤ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸ");
}

/* ===== åœæ­¢ ===== */
function stopMic() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (audioCtx) audioCtx.close();
  alert("ãƒã‚¤ã‚¯ã‚’åœæ­¢ã—ã¾ã—ãŸ");
}

/* ===== ã¡ã‹ã¾ã‚‹æœ€çµ‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ===== */
function chikamaruFinal() {
  const highPass = audioCtx.createBiquadFilter();
  highPass.type = "highpass";
  highPass.frequency.value = 220;

  const mid = audioCtx.createBiquadFilter();
  mid.type = "peaking";
  mid.frequency.value = 1800;
  mid.Q.value = 1;
  mid.gain.value = 6;

  const high = audioCtx.createBiquadFilter();
  high.type = "highshelf";
  high.frequency.value = 3200;
  high.gain.value = 5;

  const comp = audioCtx.createDynamicsCompressor();
  comp.threshold.value = -35;
  comp.knee.value = 25;
  comp.ratio.value = 4;
  comp.attack.value = 0.005;
  comp.release.value = 0.3;

  const gain = audioCtx.createGain();
  gain.gain.value = 1.6;

  const delay = audioCtx.createDelay();
  delay.delayTime.value = 0.08;

  source.disconnect();
  source.connect(highPass);
  highPass.connect(pitchNode);
  pitchNode.connect(mid);
  mid.connect(high);
  high.connect(comp);
  comp.connect(gain);
  gain.connect(delay);
  delay.connect(audioCtx.destination);
}

/* ===== ãƒœã‚¿ãƒ³ ===== */
document.querySelector(".start").onclick = startMic;
document.querySelector(".stop").onclick = stopMic;
document.querySelector(".effect").onclick = chikamaruFinal;
</script>

</body>
</html>
